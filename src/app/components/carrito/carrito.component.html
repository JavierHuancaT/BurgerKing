<!-- Overlay semitransparente (clic fuera cierra) -->
<div class="carrito-overlay" [class.active]="visible" (click)="cerrar()">
  <!-- Panel: detener el click propagation para no cerrar al interactuar dentro -->
  <div class="carrito-panel" (click)="$event.stopPropagation()">
    <div class="carrito-header">
      <h3>Tu carrito</h3>
      <button class="btn-close" (click)="cerrar()">✕</button>
    </div>

    <!-- Contenido cuando está vacío -->
    <div class="carrito-empty" *ngIf="productos.length === 0">
      <p>Tu carrito está vacío</p>
      <p class="small">Agrega productos desde el catálogo</p>
      <div class="empty-actions">
        <button class="btn-primary" (click)="cerrar()">Ver menú</button>
      </div>
    </div>

    <!-- Contenido cuando hay productos -->
    <div class="carrito-content" *ngIf="productos.length > 0">
      <div class="items-list">
        <div class="item" *ngFor="let p of productos; let i = index">
          <!-- Imagen del producto -->
          <img [src]="p.imagen || 'assets/default_product.png'" alt="{{p.nombre}}" class="item-img" />
          
          <!-- Columna izquierda: Nombre + Editar + Personalizaciones -->
          <div class="item-info">
            <div class="item-name">{{ p.nombre }}</div>
            
            <!-- Botón editar (solo si tiene productId) -->
            <a *ngIf="p.productId" 
               [routerLink]="['/personalizar', p.productId]" 
               class="btn-editar"
               (click)="cerrar()">
              Editar
            </a>

            <!-- Personalizaciones -->
            <div class="item-personalizaciones" *ngIf="p.personalizaciones && p.personalizaciones.length > 0">
              <ul>
                <li *ngFor="let personalizacion of p.personalizaciones">
                  {{ personalizacion.nombre }} (+{{ personalizacion.precio | currency:'CLP':'symbol':'1.0-0' }})
                </li>
              </ul>
            </div>
          </div>

          <!-- Columna derecha: Total + Controles de cantidad -->
          <div class="item-precio-controles">
            <!-- Precio total arriba -->
            <div class="item-precio-total">
              {{ calcularSubtotalProducto(p) | currency:'CLP':'symbol':'1.0-0' }}
            </div>

            <!-- Controles de cantidad abajo -->
            <div class="item-cantidad-control">
              <button class="qty-btn" (click)="cambiarCantidad(i, -1)">−</button>
              <span class="qty-display">{{ p.cantidad }}</span>
              <button class="qty-btn" (click)="cambiarCantidad(i, 1)">+</button>
            </div>
          </div>

          <!-- Botón X para eliminar -->
          <button class="remove" (click)="eliminarProducto(i)">✕</button>
        </div>
      </div>

      <app-retiro-comida (opcionSeleccionada)="onOpcionRetiroSeleccionada($event)"></app-retiro-comida>

      <div class="cart-summary">
        <div class="subtotal">
          <span>Subtotal</span>
          <strong>{{ calcularTotal() | currency:'CLP':'symbol':'1.0-0' }}</strong>
        </div>

        <div class="cart-actions">
          <button class="btn-secondary" (click)="vaciar()">Vaciar carrito</button>
          <button class="btn-primary" (click)="finalizarCompra()">Finalizar pedido</button>
        </div>
      </div>
    </div>
  </div>
</div>
